# service

越来越多的企业在推进数字化转型，使用大数据和数据科学来为业务赋能，获取更大的发展空间。

在大数据和数据科学领域，数据的采集，计算和使用是天然地在时间和空间上分离的。在流批一体的思想下，建立数据管道，从数据收集的内容、位置和方式开始，到数据的提取、转换、合并、验证、进一步分析数据和可视化数据的过程自动化。数据管道将所有数据视为流式数据，架构灵活，无论数据来自静态源还是实时源，数据管道都可以将数据流分割成更小的片段，并行处理提高计算能力。管道中的数据目的地除了数据仓库，还可以是其他应用程序，比如可视化工具、数据产品、搜索推荐广告机器学习引擎等。

数据服务期望能够成为数据管道自动化的一环，以服务化的方式提供数据查询服务，实现数据生产和使用的无缝衔接。

数据服务的功能在引擎节点上可以分为 2 部分：数据+服务。

数据部分主要对接多种存储系统，如 RDBMS，HDFS，elasticsearch 等存储系统提供查询功能，服务主要对外提供服务接口如http、rpc等形式供使用方以服务的形式快速接入数据。

本文讲述数据服务在自动的接口服务化方向的探索。



在微服务领域，接口是路由和功能的基本单位，也是一个最低粒度的资源管理分配单位。

如 RESTful 风格的接口：

* GET http://cn.example/user/{userId}。查询用户
* POST http://cn.example/user/{userId}?userName=foo&password=bar。添加用户
* PUT http://cn.example/user/{userId}?userName=bar。修改用户
* DELETE http://cn.example/user/{userId}。删除用户

在实现对用户的增删改查功能中，通过 `Method` 和 `URL` 实现路由到服务端的具体实现中完成功能实现。数据服务在服务化方面首先要解决服务的路由问题。

## 服务而非框架

数据服务是通过服务化的形式提供数据的查询服务。数据服务的核心之一即是对接各种存储系统，提供方便快接的查询配置或开发功能，它需要以服务化的形式对外暴露这些能力，联通应用外的世界。

## 动态的服务

配置能力。配置完毕后即可对外暴露接口，所以会有反复的注册和下线过程。

## 服务运维



## 协议

### 1. http 协议

 

### 2. rpc 协议



## 路由

### 1. 接口内部路由

很容易想到和实现的方式是在一个接口实现路由。如 ` GET http://cn.example/data-service?route=getUser&param="{userId=1}"`。通过请求参数 `route` 作为服务 key 查找需要的数据，请求参数 `param` 作为执行查询参数。

它的优点很明显，简单清晰易于实现且未来强大，比如我们可以任意定制查询协议来增加 `authentication` 和 `authorization` 请求参数实现认证和鉴权功能。

在 java 微服务中存在很多的微服务治理框架和应用提供了令人心动的功能，如服务发现、负载均衡、流量路由、限流熔断降级、trace/metrics/logs等，而这些框架和应用如果脱离了接口的概念，会出现程度不一的功能受损问题，如服务治理相关的服务动态发现完全不可用，metrics 统计的是 `data-service` 这一个 `endpoint` 的指标，而 logs 则不会受到影响。

当数据服务要以服务化来为使用方提供快速的数据接入能力的时候，如果不能与主流的微服务功能实现对接的话，需要在应用间进行上下文信息传递的场景会因为数据服务而中断，数据服务也会成为公司整个微服务体系中的一个黑洞。

而去实现这些服务治理、fault tolerate、security 或 trace/metrics/logs 等相关的功能，数据服务将变得无限臃肿。

### 2. 代码生成

在微服务中，无论是 `http` 还是 `rpc`，流行的框架都是面向开发者，帮助开发者快速开发微服务。在面向开发者的框架在遇到面向配置的数据服务时矛盾出现了：数据服务无法提供单独的功能实现类。如 user 的增删改查功能，服务端需要提供增删改查功能的代码实现，而面向配置的数据服务则显然无法提供。

为了弥补现有的微服务框架和配置化的数据服务的沟壑，代码生成的思路应运而生：根据数据模板生成相应的功能实现类。

在 java 生态中 `mybatis` 是大家常用的 `orm` 框架，而开发者对于易于出错的 `mapper.xml` 文件的配置一般是通过代码生成的方式来处理。除了 `mybatis` 提供的代码 `mybatis-generator`，还有很多类似的工具以及插件实现同样的功能，而有些的实现方式是通过模板来实现，如 `freemarker`、`thymeleaf`、`mustache` 等。而有些则是通过字节码技术来生成如 `asm` 和 `javaassist`。 

#### 模板引擎



#### javaassist

类加载器。反复生成的问题

dubbo 兼容问题。

服务注册和下线问题。

### 3. 自研 `http` 服务器

经过对 `dubbo` 的 `tcp` 服务器，`elasticsearch` 的 `tcp` 和 `http` 服务器的源码的剖析，决定自研 `http` 服务器和对 `springmvc` 改造。



如果接口失去了路由，那么服务

在微服务领域，接口是一个最低粒度的资源管理单位。如接口的熔断限流资源，

服务器资源，jvm资源，数据库连接池资源。

接口是路由和功能的基本单位。

